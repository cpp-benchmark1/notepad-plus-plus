name: "CodeQL Analysis"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      languages:
        description: "Languages to analyze"
        required: true
        default: "c-cpp"

jobs:
  codeql:
    name: Analyze
    runs-on: windows-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install MSYS2 toolchain
        shell: pwsh
        run: |
          choco install msys2 -y
          refreshenv
          C:\msys64\usr\bin\bash.exe -lc "pacman -Syu --noconfirm"
          C:\msys64\usr\bin\bash.exe -lc "pacman -S --noconfirm --needed mingw-w64-x86_64-toolchain mingw-w64-x86_64-curl mingw-w64-x86_64-libxml2 mingw-w64-x86_64-mongo-c-driver"
          # Optional dependencies used by historical configurations; ignore if missing
          C:\msys64\usr\bin\bash.exe -lc "pacman -S --noconfirm --needed mingw-w64-x86_64-libssh || true"
          C:\msys64\usr\bin\bash.exe -lc "pacman -S --noconfirm --needed mingw-w64-x86_64-mysql || echo 'mingw-w64-x86_64-mysql not available, continuing'"
          echo "C:\msys64\usr\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "C:\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: cpp
          build-mode: manual

      - name: Build project
        shell: pwsh
        run: |
          # Create placeholder for required bin asset
          $binDir = "$env:GITHUB_WORKSPACE\PowerEditor\bin"
          New-Item -ItemType Directory -Path $binDir -Force | Out-Null
          $changeLog = Join-Path $binDir "change.log"
          if (!(Test-Path $changeLog)) { Set-Content -Path $changeLog -Value "Placeholder changelog for CI" }
          
          $env:CPATH = "C:\msys64\mingw64\include\libxml2;C:\msys64\mingw64\include\libbson-1.0;C:\msys64\mingw64\include\libmongoc-1.0;" + $env:CPATH
          $env:LIBRARY_PATH = "C:\msys64\mingw64\lib;" + $env:LIBRARY_PATH
          $env:PKG_CONFIG_PATH = "C:\msys64\mingw64\lib\pkgconfig"
          gcc --version
          make --version
          make -f PowerEditor\gcc\makefile

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:cpp"
