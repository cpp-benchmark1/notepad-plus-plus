name: "CodeQL Analysis"

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  codeql:
    runs-on: windows-latest
    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install MSYS2 toolchain
        shell: pwsh
        run: |
          choco install msys2 -y
          refreshenv
          C:\msys64\usr\bin\bash.exe -lc "pacman -Syu --noconfirm"
          C:\msys64\usr\bin\bash.exe -lc "pacman -S --noconfirm mingw-w64-x86_64-toolchain mingw-w64-x86_64-curl mingw-w64-x86_64-libxml2 mingw-w64-x86_64-libssh mingw-w64-x86_64-mysql"
          echo "C:\msys64\usr\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8
          echo "C:\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8

      - name: Initialize CodeQL (C/C++ manual build)
        uses: github/codeql-action/init@v3
        with:
          languages: cpp
          build-mode: manual

      - name: Build project (manual)
        shell: pwsh
        run: |
          $codeql_db = "$env:GITHUB_WORKSPACE\codeql_db"
          mkdir $codeql_db


          $env:CPATH = "/c/msys64/mingw64/include/libxml2:/c/msys64/mingw64/include/libssh:/c/msys64/mingw64/include/mysql"
          $env:LIBRARY_PATH = "/c/msys64/mingw64/lib"
          $env:PKG_CONFIG_PATH = "/c/msys64/mingw64/lib/pkgconfig"

          $env:INCLUDE = "/c/${env:GITHUB_WORKSPACE}/PowerEditor/gcc"


          C:\msys64\usr\bin\bash.exe -lc "make -f PowerEditor/gcc/makefile || true"

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:cpp"
