name: CodeQL Analysis

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      languages:
        description: "Languages to analyze"
        required: true
        default: "cpp"

jobs:
  analyze:
    runs-on: windows-latest
    permissions:
      security-events: write
      contents: read
      actions: read
      packages: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install MSYS2 toolchain
        shell: pwsh
        run: |
          choco install msys2 -y
          refreshenv
          C:\msys64\usr\bin\bash.exe -lc "pacman -Syu --noconfirm"
          C:\msys64\usr\bin\bash.exe -lc "pacman -S --noconfirm mingw-w64-x86_64-toolchain mingw-w64-x86_64-curl mingw-w64-x86_64-libxml2"
          echo "C:\msys64\usr\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          echo "C:\msys64\mingw64\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ github.event.inputs.languages }}
          build-mode: manual

      - name: Build project (captured by CodeQL)
        shell: pwsh
        run: |

          $binDir = "$env:GITHUB_WORKSPACE\PowerEditor\bin"
          New-Item -ItemType Directory -Path $binDir -Force | Out-Null
          $changeLog = Join-Path $binDir "change.log"
          if (!(Test-Path $changeLog)) { Set-Content -Path $changeLog -Value "Placeholder changelog for CI" }


          $winInclude = 'C:\Progra~2\Windows Kits\10\Include\10.0.22621.0\um'
          $winShared  = 'C:\Progra~2\Windows Kits\10\Include\10.0.22621.0\shared'
          $env:CPATH = "$winInclude;$winShared;C:\msys64\mingw64\include\libxml2;" + $env:CPATH
          $env:LIBRARY_PATH = "C:\msys64\mingw64\lib;" + $env:LIBRARY_PATH
          $env:PKG_CONFIG_PATH = "C:\msys64\mingw64\lib\pkgconfig"

          gcc --version | Select-Object -First 1
          make --version | Select-Object -First 1


          make -f PowerEditor\gcc\makefile || true

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:cpp"

      - name: Upload build logs (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: codeql-build-logs
          path: '**/build*.log'
